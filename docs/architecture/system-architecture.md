# 系统架构设计

## 概述

Message Mirror 是一个插件化的消息镜像工具，采用模块化设计，支持多种数据源和目标系统。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      Web UI (前端)                           │
│              (配置管理、监控、状态查看)                        │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/WebSocket
┌──────────────────────▼──────────────────────────────────────┐
│                    HTTP Server                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Health API  │  │  Metrics API │  │  Config API  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                   MirrorMaker                               │
│  ┌────────────────────────────────────────────────────┐   │
│  │              Source Plugin                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │  Kafka   │  │ RabbitMQ │  │   File   │        │   │
│  │  └──────────┘  └──────────┘  └──────────┘        │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │          Message Processing Pipeline               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐       │   │
│  │  │ Dedup   │→ │  Retry   │→ │  Batch   │       │   │
│  │  └──────────┘  └──────────┘  └──────────┘       │   │
│  └────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────┐   │
│  │              MirrorProducer                        │   │
│  │              (Kafka Producer)                      │   │
│  └────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              Target Kafka Cluster                          │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Source Plugin (数据源插件)

**职责**：
- 从各种数据源读取消息
- 将消息转换为统一的 `Message` 格式
- 处理数据源特定的错误和重连

**支持的插件**：
- Kafka Plugin: 从Kafka集群消费消息
- RabbitMQ Plugin: 从RabbitMQ队列消费消息
- File Plugin: 监控文件系统变化并读取文件

### 2. MirrorMaker (核心镜像器)

**职责**：
- 协调各个组件的工作
- 管理消息处理流程
- 提供统计信息和状态查询

**关键特性**：
- 多Worker并发处理
- 速率限制（消息级和字节级）
- 批处理支持
- 优雅关闭

### 3. Message Processing Pipeline (消息处理管道)

**组件**：
- **Deduplicator**: 消息去重，避免重复处理
- **RetryManager**: 错误重试，指数退避策略
- **BatchProcessor**: 批处理，提高吞吐量

### 4. MirrorProducer (生产者)

**职责**：
- 将消息发送到目标Kafka集群
- 处理压缩、分区、幂等性等
- 支持TLS/SSL和SASL认证

### 5. HTTP Server

**职责**：
- 提供健康检查接口
- 暴露Prometheus指标
- 提供配置管理API
- 提供Web UI服务

### 6. Web UI

**职责**：
- 配置管理界面
- 实时监控和状态查看
- 配置热重载

## 数据流

### 消息处理流程

```
Source Plugin → Message Channel → Worker Pool
    ↓
Deduplicator (检查是否重复)
    ↓
RetryManager (处理错误)
    ↓
BatchProcessor (可选，批处理)
    ↓
Rate Limiter (速率限制)
    ↓
MirrorProducer → Target Kafka
```

### 配置管理流程

```
Web UI → Config API → Config Manager
    ↓
Validate Config
    ↓
Hot Reload → MirrorMaker
    ↓
Update Components
```

## 技术栈

### 后端
- **语言**: Go 1.21+
- **框架**: 
  - Cobra (CLI)
  - Viper (配置管理)
- **Kafka客户端**: IBM Sarama
- **RabbitMQ客户端**: streadway/amqp
- **HTTP服务器**: net/http
- **监控**: Prometheus Client

### 前端
- **框架**: React / Vue.js (待定)
- **UI库**: Ant Design / Element UI (待定)
- **实时通信**: WebSocket

## 设计原则

### 1. 插件化
- 所有数据源通过插件接口实现
- 易于扩展新的数据源类型
- 插件之间相互独立

### 2. 可配置
- 所有参数可通过配置文件或Web UI配置
- 支持配置热重载
- 配置验证和默认值

### 3. 可观测
- Prometheus指标暴露
- 详细的日志记录
- 健康检查和就绪检查

### 4. 高可用
- 优雅关闭
- 错误重试机制
- 连接池和资源管理

### 5. 性能优化
- 批处理支持
- 连接池
- 速率限制
- 消息缓存

## 扩展性

### 水平扩展
- 支持多个实例并行运行
- 通过Consumer Group实现负载均衡

### 垂直扩展
- 可配置Worker数量
- 可配置批处理大小
- 可配置缓冲区大小

## 安全性

- TLS/SSL支持
- SASL认证
- 配置加密（可选）
- 安全审计日志

